## 图床(PicBed)开发说明（ 项目示例地址:http://8.129.15.139:8090/picbed ）

#### 1.技术框架

springboot+mysql+nginx静态服务器

#### 2.现有功能

1.首页分页图片展示，支持分页查看，点击图片大图查看

![image-20210331151636486](C:\Users\zt\AppData\Roaming\Typora\typora-user-images\image-20210331151636486.png)

2.爬虫配置，目前只支持花瓣网的爬取，支持栏目爬取（对栏目下所有画板进行爬取）和指定画板爬取，每个画板采用一个单独线程进行。

![image-20210331151850939](C:\Users\zt\AppData\Roaming\Typora\typora-user-images\image-20210331151850939.png)

#### 3.下一步实现功能

1.增加爬虫源，先从爬取微博开始（爬取微博用户所有微博配图，已用python实现，需要使用java重新实现）；
2021-4-1：基本代码实现，目前采用单线程对单个用户进行爬取配图，后续将采用线程池对每页的微博进行线程分配式爬取。

2.首页显示图片细化分类，如图片来源（花瓣网，微博...）,图片类型(动漫，美女...)
2021-4-6:前端页面以及后端查询已支持实现分类查询

3.首页增加随机图片选项，随机从数据库抽取20张图片展示；
2021-4-6：新增随机展示20图（不分类型及来源），每次刷新页面重新查取

4.界面ui优化(主要解决图片大小不一的问题)；
2021-4-6:实现尺寸不一的图片自适应同一大小（虽然会有拉伸效果影响观感）

#### 4.未来预想功能

1.爬虫过程设置进度条显示（可显示启动的爬虫爬取进度）

实现想法：

以花瓣网为例，首先获取所有画板，每个画板一个进度条，其次查出画板下所有图片数量设为进度条总数，之后实时存储已爬取数量到redis中，前端定时查询redis更新进度条。

技术参考：

https://www.jianshu.com/p/836e5a9daeb2

![image-20210331152608148](C:\Users\zt\AppData\Roaming\Typora\typora-user-images\image-20210331152608148.png)

2.可能增加用户管理登录验证等门户管理模块，对外宣传开放平台。（目前自用）

3.移动端或小程序开发或前后端（vue）分离，采用热门友好的前端框架重构前端页面

#### 5.开发过程记录
1.目前项目采取的线程模块为java原生线程，通过继承Thread类实现，而且需要手动创建实例对象，后续考虑引入线程池管理和分配线程。--2021-4-1

2.已将爬虫多线程的实现方式重构为线程池的统一管理分配方式。--2021-4-8

3.目前已对微博爬虫的前端进度显示进行了基本的代码实现（使用测试方法代替原方法），但是实现代码思路还不够好，后续将完善这一功能，主要完善点如下：
（1）存入到redis的数据分类，如将微博类的所有爬取数据存入到一条redis数据中；
（2）如微博能显示每页的进度数据的同时也能查看总进度（一个进度条）；
（3）花瓣网分标签和单个画板爬取。此时进度条应该怎么设计；
（4）线程池的分配问题，如当我启动一个微博爬虫后再次启动一个其他爬虫，此时的话会等待第一个微博爬虫任务结束后才会开始后面的爬虫任务，这个功能该怎么优化，是该爬虫之间独立线程池分配还是保持原状共享同一个线程池分配。
--2021-4-9

4.引入springsecurity模块，加入登录验证用户和部分请求根据用户权限控制等功能，大致实现基础功能，任需完善，后续大概率就门户管理这个模块继续完善--2020-4-13

5.继续完善爬虫进度展示模块，将爬虫展示集中展示在一个页面显示，主要调整redis存储方式。
（应该设置redis数据有效时间及时清除数据，且爬取完成的爬虫将存活设为0不再展示在进度页面，页面的定时发送请求获取进度数据应该优化，否则爬虫过多会导致大量请求到后台。目前方案是监控爬虫完成后自动停止请求获取，
redis对每个爬虫再存入一个值，是否完成。前端也应该设置一个总进度条。）--2021-4-21
多线程同步问题（多个线程同时修改redis同key值时有问题）卡住且暂无解决方案 --2021-4-22
此问题已解决，加synchronized关键字即可。 --2021-4-23

6.存入数据库和下载图片分开进行，设置定时任务下载图片，暂时采用单线程下载图片。  --2021-4-23

7.设置爬虫爬取完毕操作：设置爬虫记录为非存活，清除redis中相关的进度数据，前端不再定时请求此爬虫的进度数据。  --2021-4-25

8.图片管理功能进一步完善，增加手动下载图片反馈以及删除图片功能。  --2021-4-27

9.修改图片管理模块，去掉全部图片下载（由于是主线程且是单线程下载会拖累整个项目性能，图片数据大的情况下），改为对每个博主下的图片进行下载，同时将下载也改为线程池分配线程形式（此线程池为单独的下载线程，区别于爬虫线程池），
增加下载进度条（redis实现）。      --2021-4-29

#### 6.问题记录
1.前端开始爬虫后跳转页面为当前爬虫进度，地址栏为启动爬虫的请求，如果刷新此页面会造成重新启动爬虫，应该设计为启动爬虫请求后台转发到爬虫进度页面。
思路记录:所有启动爬虫记录，爬虫进度页面记录所有爬虫，设计爬虫记录表，一方面对爬虫进行系统性的记录，另一方面对存活爬虫进行页面进度统计。

--2021-4-19

2.想到一个想法，在爬取图片时可以先将图片的源url存到数据库，图片下载可放在后台慢慢下载，
前台展示可直接展示源url图片 ，这样爬取效率会大大提高，但是也有一个问题，应该给哪些图片设置源url，
哪些设置本地url，或者应该怎么设限制。
思路记录:图片实例表新增图片源url字段和存入数据库时间，前端拿到图片实例对象集合后，判断每个图片的
存入数据库时间是否大于24小时，大于就设置为本地url，否则设置为网络源url。
难点:可能要设计两个线程池，一个负责爬取数据保存到数据库，一个负责后台下载图片。
新的思路：下载图片和存数据库不一起进行，定时任务每天晚上执行下载图片方法，图片实例表加一个是否下载字段，直接在数据库中查询未下载的图片数据然后进行单线程下载。

--2021-4-21

3.对于重复爬虫应该怎么处理，比如微博对同一个用户不同时间爬取，第二次应该怎么爬取（全量肯定是不合适）。
思路记录：1.重复爬虫增量爬取（怎么实现目前没想好）2.自动更新爬取，时间间隔内爬取已存在的目标爬虫，则前端提示目标爬虫已存在不允许手动爬取。
3.由此想到微博爬虫添加换种思路，即按博主进行爬取，可以设置某个博主的资源是否自动更新（即自动爬取），也可实现图片按博主分类；

--2021-4-22

4.应新增图片管理功能，对图片的分类以及删除操作，可看到已下载了哪些图片， 
未下载哪些图片（可选择哪些图片立即下载）;图片下载到本地等操作（这个功能我觉得放在前端展示页面比较好）；
未来展望：加入智能识别功能（人脸，宠物，风景；其他只能识别分类）。     

--2021-4-23

5.怎么判断爬虫爬取完毕，爬虫完毕后设置此爬虫记录数据为非存活状态（前端爬虫记录还需不需要查非存活爬虫，或者另起一页爬虫记录管理），同时需要删掉redis中爬虫进度数据（设置redis过期时间自动删除还是判断爬虫完成后代码删除）。

--2021-4-25

6.图片的管理功能完善思路，包括手动下载图片的结果反馈等（进度条，爬取结果成功多少条失败多少条），图片按博主分类等，（手动添加图片？）图片的删除等（删除逻辑：按博主分类删除还是定向删除某张图片，需要考虑之后的重复博主图片爬取模块设计），（时间轴分类？已下载未下载分类）分类后图片实例以怎样的形式展示（图片形式太耗时，图片名形式太丑）等等。

--2021-4-25

7.后续考虑还是应该把对博主下的图片数据进行下载，主要问题是避免重复下载，即所有图片下载时不能操作单个博主下载，这个问题可以判断下载状态解决，但是不同博主之间的资源下载应该怎么处理，还是以单线程形式判断下载状态不允许多个下载请求还是以多线程形式进行，还有一种思路就是单线程的线程池，虽然同时只有一个线程在下载图片但是允许提交多个下载请求，后续下载任务存到线程池队列中等待下载，感觉这种方式更好，必要情况可去掉对全部图片的下载操作。

--2021-4-28

8.需要考虑图片分类了，如果确认放弃花瓣网爬虫应该以什么形式给图片分类（博主，标签式）。
还有就是图片的本地下载功能（从页面下载到本地），从服务器打包下载整个博主的图片，线上未下载的应该怎么处理。

--2021-4-29